<!DOCTYPE html>
<html>
<head>
<link rel="shortcut icon" href="#">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="./class.js"></script>
<script>
let BPM = 50;
let VOLUME = 50;
let MODE = 1;
let nm_list = ["note", "chordtone", "tension", "form"]
let major_scale = [2, 2, 1, 2, 2, 2, 1];
let songs = [];
let cur_song_idx = -1;

//let piano_audioes = [];

function changecss(theClass,element,value) {
    //Last Updated on July 4, 2011
    //documentation for this script at
    //http://www.shawnolson.net/a/503/altering-css-class-attributes-with-javascript.html
    let cssRules;

    for (let S = 0; S < document.styleSheets.length; S++){
        try{
            document.styleSheets[S].insertRule(theClass+' { '+element+': '+value+'; }',document.styleSheets[S][cssRules].length);
        } catch(err){
            try{document.styleSheets[S].addRule(theClass,element+': '+value+';');
            } catch(err){
                try{
                    if (document.styleSheets[S]['rules']) {
                        cssRules = 'rules';
                    } else if (document.styleSheets[S]['cssRules']) {
                        cssRules = 'cssRules';
                    } else {
                        //no rules found... browser unknown
                    }
                    for (let R = 0; R < document.styleSheets[S][cssRules].length; R++) {
                        if (document.styleSheets[S][cssRules][R].selectorText == theClass) {
                            if(document.styleSheets[S][cssRules][R].style[element]){
                                document.styleSheets[S][cssRules][R].style[element] = value;
                                break;
                            }
                        }
                    }
                } catch (err){}
            }
        }
    }
}

function make_scale(note) {
    octave = [];
    note = Note.name2num(note);

    octave.push(note);
    for (let i in major_scale) {
        num = (octave[octave.length-1]+major_scale[i])%12;
        octave.push(num);
    }
    octave.pop();

    return octave;
}

function print_chord(chord_text, mark_piano_yn) {
    document.getElementById("chord").innerHTML = chord_text;
    cdtone = Chord.chordtone(chord_text);
    document.getElementById("chordtone").innerHTML = Note.num2name(cdtone).toString();
    if (mark_piano_yn) {
        Piano.mark_piano(cdtone);
    }
}

function auto_print_chord() {
    clearTimeout(timerid);

    timerid = setTimeout(
        function timer() {
            // if (idx < chord_arr.length) {
            //     print_chord(chord_arr[idx], true);
            //     setTimeout(timer, 1000*60/BPM, idx+1);
            // }
            if (PlayingChordList.isLast()) return;

            chord = PlayingChordList.next();
            mark_piano_yn = (MODE == 0);
            print_chord(chord, mark_piano_yn);

            if (BPM > 0) timerid = setTimeout(timer, 1000*60/BPM);
        }
        , 0
    );
}

function is_correct() {
    let ct = document.getElementById("chordtone").innerText.split(",");
    let select_list = Object.assign([], Piano.selected_keys);
    select_list.sort((a, b) => {
        let a_num = Note.names.indexOf(a.substr(0, a.length-1)) + parseInt(a[a.length-1]) * 12 + 12;
        let b_num = Note.names.indexOf(b.substr(0, b.length-1)) + parseInt(b[b.length-1]) * 12 + 12;
        return a_num-b_num;
    });
    //console.log(select_list);

    // for (i in Piano.piano_octave)
    //     for (j in Note.names)
    //         if (document.getElementById(Note.names[j]+Piano.piano_octave[i]).className.split(" ").length > 1)
    //             select_list.push(Note.names[j])

    if (select_list.length != ct.length) return false;

    for (let i in ct)
        if (ct[i] != select_list[i].substr(0, select_list[i].length-1)) return false;

    return true;
}

function init_setting() {
    let list = [Note.names, Chord.chordtones, Chord.tensions, Chord.forms]

    //setting 생성
    let set_div = document.getElementById("setting");
    for (let i in list) {
        for (let j in list[i]) {
            // set_div.innerHTML +=
            // "<label for='chk_"+ nm_list[i]+"_"+j +"' class='label_set'>"
            // + "<input type='checkbox' class='chk' name='chk_"+nm_list[i]+"' value='"+j+"' id='chk_"+ nm_list[i]+"_"+j +"' checked='checked'> "
            // + list[i][j] + "</label> "
            // ;
            let label = document.createElement("label");
            label.setAttribute("for", "chk_" + nm_list[i] + "_" + j);
            label.setAttribute("class", "label_set");
            let checkbox = document.createElement("input");
            checkbox.setAttribute("type", "checkbox");
            checkbox.setAttribute("class", "chk");
            checkbox.setAttribute("name", "chk_"+nm_list[i]);
            checkbox.setAttribute("value", ""+j);
            checkbox.setAttribute("id", "chk_"+ nm_list[i]+"_"+j);
            checkbox.setAttribute("checked", "checked");
            label.appendChild(checkbox);
            if (list[i][j] == "")
                label.innerHTML += "없음";
            else
                label.innerHTML += list[i][j];
            set_div.appendChild(label);
        }

        set_div.appendChild(document.createElement("br"));

    }

    //piano 생성
    piano = document.getElementById("piano");
    Piano.make_keys(piano);
    Piano.set_piano_size(2);

    //초기값설정
    chks = document.getElementsByName("chk_tension");
    for (j in chks) chks[j].checked = false;

    // 이벤트 리스너 설정
    // next btn
    document.querySelector('#next_btn').addEventListener('click',function(){
        if (MODE == 0) {auto_print_chord();}
        else if (MODE == 1) {print_chord(PlayingChordList.next());}
        else {alert("오류 !");}
        //change_mode(MODE);
    });
    // mode change
    document.getElementsByName("mode").forEach((radio) => {
        radio.addEventListener('change',function(){
            //change_mode(this.value);
            MODE = this.value;
        })
    });
    // piano change
    piano.addEventListener('click',function(e){
        if (MODE == 1) {
            Piano.key_select(e.target.getAttribute("id"), false);
            if (is_correct()) {
                for (i in Piano.selected_keys) {
                    document.getElementById(Piano.selected_keys[i]).style.backgroundColor = "#368AFF";
                    Piano.play_sound(Piano.selected_keys[i], true);
                }
                
                setTimeout(
                    function(){
                        Piano.clear_piano();
                        print_chord(PlayingChordList.next());
                    }
                    , 2000
                );
            }
        }
    });
    //파일 업로드
    document.getElementById("file").addEventListener("change", (event) => {
        const file = event.target.files[0]; // file 객체
        const reader = new FileReader(); // fileReader 생성
        reader.readAsText(file);
        reader.onload = function (e) {
        // load 이벤트의 핸들러. 이 이벤트는 읽기 동작이 성공적으로 완료 되었을 때마다 발생
            songs.push(new SheetMusic(e.target.result.split(/\s+/)));
            cur_song_idx = songs.length-1;
            PlayingChordList.setChords(songs[cur_song_idx]);
        }
        reader.onerror = function (e) {
            cur_song_idx = -1;
            change_mode(MODE);
        }
    });
}

function get_checked_ids() {
    let ids = [];
    for (let i in nm_list) {
        ids.push([]);
        chks = document.getElementsByName("chk_"+ nm_list[i]);
        for (let j in chks)
            if (chks[j].checked)
                ids[i].push(j);
    }
    return ids;
}

function change_mode(mode) {
    MODE = mode;
    clearTimeout(timerid);
    Piano.clear_piano();
    let chords = [];

    if(cur_song_idx < 0) {
        ids = get_checked_ids();
        chords = Chord.rand_chords_generate(ids, 10000);
    }
    else {
        chords = songs[cur_song_idx].chord_list;
    }
    PlayingChordList.setChords(chords);

    // 모드 0: 자동 코드
    auto_print_chord();
    if (mode == 0) {
        document.getElementById("chordtone").style.display = "block";
        console.log("자동 모드 전환");
    }
    // 모드 2: 맞추기
    else if (mode == 1) {
        //document.getElementById("chordtone").style.display = "none";
        console.log("맞추기 모드 전환");
        //print_chord(PlayingChordList.next());
    }
}

function setBPM() {
    BPM = document.getElementById("bpm").value;
}

function setting_display(flag) {
    if (flag) {
        document.getElementById("setting_btn").style.display = "none";
        document.getElementById("next_btn").style.display = "none";
        document.getElementById("setting").style.display = "block";
    }
    else {
        document.getElementById("setting").style.display = "none";
        document.getElementById("setting_btn").style.display = "block";
        document.getElementById("next_btn").style.display = "block";
    }
}

window.onload = function() {
    // oct = make_scale("C");
    // nm = Note.num2name(oct);
    //
    // dv = document.getElementById("chord");
    // dv.innerHTML = "C Major Scale : " + nm.toString() + "<br/>";
    //
    // chord = "DmM7 [A form]"
    // ct = Note.num2name(Chord.chordtone(chord));
    // dv.innerHTML += chord + ct.toString() + "<br/>";
    init_setting();
    change_mode(MODE);
    // song1 = new SheetMusic(["A#(Bb)", "-", "Cm7.2", "-","Dm7.1" ,"-" , "Gm7", "-"]);
    // songs.push(song1);

    //setBPM();
}

</script>
<style>
.label_set {
    background-color:#1F51B7;
    color:white;
    padding:10px;
    margin: 5px 0 5px 5px;
    display:inline-block;
    border-radius: 15px;
}
.chk {
    width:25px;
    height:25px;
}
.setting_btn {
    font-weight:bold;
    background-color:#1F51B7;
    color:white;
    padding:10px 20px 20px 20px;
    border-radius: 15px;
    right:0;
    /*float:right;*/
    display:block;
    position:absolute;
}
.white_key {
    padding:0;
    margin:0;
    border:1px solid black;
    display:block;
    float:left;
    /* 표준
    height:140~150px;
    width:23.5px; */
    /* 집
    height:13.5;
    width:2.1px;
    */
    height:100px;
    width:20px;
}
.black_key {
    padding:0;
    margin:0;
    border:1px solid black;
    background-color: black;
    display:block;
    position:relative;

    height:50px;
    width:5px;
    /* 표준
    height:95px;
    width:9~11px; */
    /* 집
    height:8.5px;
    width:1px;
    */
}
.selected_key {
    background-color: #FFA648;
}
.selected_root_key {
    background-color: #368AFF;
}
#piano {
    /* display:grid;
    place-content:center; */
    display:flex;
    justify-content: center;
    align-items: center;
    /* left: 25%; */
    /* transform: translateX(-50%); */
}
#setting {
    border-radius: 0 0 15px 15px;
    background-color:#B2CCFF;
    padding:20px;
    display:none;
}
</style>
</head>
<body style="font-size:x-large;margin:0">
    <a id="setting_btn" class="setting_btn" onclick="clearTimeout(timerid);setting_display(true);">setting</a>
    <a id="next_btn" class="setting_btn" style="right:124px">Next</a>
    <div id ="setting">
        <div style="display:block;position:absolute;right:20px;font-weight:bold"font-size:xxx-large; onclick="change_mode(MODE);setting_display(false)">X</div>
        <p style="font-size:xx-large;margin-top:0px;">
            <label for="mode_0">
                <input type="radio" name="mode" id="mode_0" value="0" class="chk"/> 자동
            </label>
            <label for="mode_1">
                <input type="radio" name="mode" id="mode_1" value="1" class="chk" checked="checked"/> 맞추기
            </label>
        </p>
        <input type="text" id="bpm" value="50" style="width:150px;height:50px;font-size:xx-large;text-align:center;"/>
        <button onclick="setBPM()" id="bpm_set_btn" style="width:150px;height:50px;font-size:xx-large;">BPM적용</button>
        &nbsp;&nbsp;
        <input type="text" id="volume" value="50" style="width:150px;height:50px;font-size:xx-large;text-align:center;"/>
        <button onclick="VOLUME=document.getElementById('volume').value;" id="volume_set_btn" style="width:150px;height:50px;font-size:xx-large;">볼륨적용</button>
        <!--<input type="button" onclick="setBPM()" style="width:150px;height:50px;font-size:xx-large;" value="BPM적용"/>-->
        <br />
        <input type='file' id="file" style="font-size:xx-large;"/>
        <br />
    </div>
    <div id="chord" style="font-size:xxx-large;text-align:center">
    </div>
    <div id="chordtone" style="font-size:x-large;text-align:center">
    </div>
    <br/>
    <div id="piano">
    </div>
</body>
</html>
